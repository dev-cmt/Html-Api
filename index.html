<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frodly API Processor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; }
        .card { border-radius: 10px; border: none; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .status-badge { font-size: 0.75rem; }
        .url-badge { font-size: 0.7rem; background: #6c757d; color: white; }
        .result-row { transition: all 0.3s; }
        .result-row:hover { background-color: #f8f9fa; }
        .success { border-left: 4px solid #28a745 !important; }
        .error { border-left: 4px solid #dc3545 !important; }
        .processing { border-left: 4px solid #17a2b8 !important; }
        .pending { border-left: 4px solid #ffc107 !important; }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-mobile-alt"></i> Frodly API Phone Processor</h4>
                <small class="text-white-50">Testing API endpoints for phone number processing</small>
            </div>
            
            <div class="card-body">
                <!-- URL Tester -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-link"></i> Test API Endpoint</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Test Phone Number</label>
                                <input type="text" id="testNumber" class="form-control" value="01641389658" placeholder="Enter phone number">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">API URL</label>
                                <select id="apiUrl" class="form-select">
                                    <option value="/api/frodly-test">/api/frodly-test</option>
                                    <option value="/public/api/frodly-test" selected>/public/api/frodly-test</option>
                                    <option value="/frodly-test">/frodly-test</option>
                                    <option value="/public/frodly-test">/public/frodly-test</option>
                                </select>
                            </div>
                        </div>
                        <button id="testApiBtn" class="btn btn-primary">
                            <i class="fas fa-vial"></i> Test API Call
                        </button>
                        <div id="apiTestResult" class="mt-3" style="display: none;">
                            <div class="alert" id="testResultAlert">
                                <!-- Result will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Processor -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-cogs"></i> Batch Processor</h6>
                    </div>
                    <div class="card-body">
                        <!-- Stats -->
                        <div class="row mb-4 text-center">
                            <div class="col-3">
                                <div class="border rounded p-3">
                                    <h3 id="totalCount">0</h3>
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="border rounded p-3">
                                    <h3 id="processedCount">0</h3>
                                    <small class="text-muted">Processed</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="border rounded p-3">
                                    <h3 id="successCount">0</h3>
                                    <small class="text-muted">Success</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="border rounded p-3">
                                    <h3 id="errorCount">0</h3>
                                    <small class="text-muted">Errors</small>
                                </div>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="d-flex gap-2 mb-4 flex-wrap">
                            <button id="startBtn" class="btn btn-success">
                                <i class="fas fa-play"></i> Start Processing
                            </button>
                            <button id="pauseBtn" class="btn btn-warning" disabled>
                                <i class="fas fa-pause"></i> Pause
                            </button>
                            <button id="stopBtn" class="btn btn-danger">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                            <button id="resetBtn" class="btn btn-secondary">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>

                        <!-- Progress -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-1">
                                <small id="statusText">Ready to start</small>
                                <small id="progressPercent">0%</small>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     style="width: 0%"></div>
                            </div>
                            <div id="countdownInfo" class="text-center mt-2"></div>
                        </div>

                        <!-- Results Table -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th width="150">Phone Number</th>
                                        <th width="100">Status</th>
                                        <th>Response</th>
                                        <th width="150">Time</th>
                                        <th width="100">URL Used</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTable">
                                    <tr id="noResults">
                                        <td colspan="5" class="text-center text-muted py-4">
                                            No results yet. Click "Test API Call" or "Start Processing"
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Phone numbers to process
            const phoneNumbers = [
                "01738606158", "01726319619", "01879200750", "01641389658", "01812337616",
                "01946377865", "01711506053", "01917984002", "01796355555", "01772366352"
                // Add more numbers as needed
            ];

            // Application state
            const state = {
                index: 0,
                processed: 0,
                success: 0,
                errors: 0,
                isRunning: false,
                isPaused: false,
                timer: null,
                workingUrl: null
            };

            // Initialize
            $('#totalCount').text(phoneNumbers.length);
            updateProgress();

            // Event Listeners
            $('#testApiBtn').click(testApiEndpoint);
            $('#startBtn').click(startProcessing);
            $('#pauseBtn').click(togglePause);
            $('#stopBtn').click(stopProcessing);
            $('#resetBtn').click(resetProcessing);

            // Test single API endpoint
            async function testApiEndpoint() {
                const number = $('#testNumber').val().trim();
                const apiPath = $('#apiUrl').val();
                const url = `http://beta.frodlybd.com${apiPath}?number=${encodeURIComponent(number)}`;
                
                $('#testApiBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Testing...');
                $('#apiTestResult').hide();
                
                try {
                    const response = await $.ajax({
                        url: url,
                        method: 'GET',
                        dataType: 'json',
                        timeout: 10000,
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    // Success - store this URL for batch processing
                    state.workingUrl = `http://beta.frodlybd.com${apiPath}`;
                    $('#testResultAlert')
                        .removeClass('alert-danger')
                        .addClass('alert-success')
                        .html(`
                            <h6><i class="fas fa-check-circle"></i> API Test Successful!</h6>
                            <p><strong>URL:</strong> ${url}</p>
                            <p><strong>Response:</strong> ${JSON.stringify(response, null, 2)}</p>
                            <p class="mb-0 text-success"><i class="fas fa-check"></i> This URL will be used for batch processing.</p>
                        `);
                    
                } catch (error) {
                    $('#testResultAlert')
                        .removeClass('alert-success')
                        .addClass('alert-danger')
                        .html(`
                            <h6><i class="fas fa-times-circle"></i> API Test Failed</h6>
                            <p><strong>URL:</strong> ${url}</p>
                            <p><strong>Error:</strong> ${error.statusText || error.status}</p>
                            <p><strong>Status:</strong> ${error.status}</p>
                            <p class="mb-0"><strong>Response:</strong> ${error.responseText || 'No response'}</p>
                        `);
                } finally {
                    $('#apiTestResult').show();
                    $('#testApiBtn').prop('disabled', false).html('<i class="fas fa-vial"></i> Test API Call');
                }
            }

            // Update progress display
            function updateProgress() {
                const percent = phoneNumbers.length > 0 ? 
                    Math.round((state.processed / phoneNumbers.length) * 100) : 0;
                
                $('#progressBar').css('width', percent + '%');
                $('#progressPercent').text(percent + '%');
                $('#processedCount').text(state.processed);
                $('#successCount').text(state.success);
                $('#errorCount').text(state.errors);
                
                if (state.isRunning && !state.isPaused) {
                    $('#statusText').html(
                        `Processing: <strong>${state.index + 1}</strong> of ` +
                        `<strong>${phoneNumbers.length}</strong>`
                    );
                } else if (state.isPaused) {
                    $('#statusText').text('PAUSED');
                } else if (state.processed === phoneNumbers.length) {
                    $('#statusText').html('<strong class="text-success">COMPLETE</strong>');
                } else {
                    $('#statusText').text('Ready');
                }
            }

            // Add result to table
            function addResult(number, status, response, urlUsed = null) {
                // Remove "no results" row if present
                if ($('#noResults').length) {
                    $('#noResults').remove();
                }

                // Determine badge color
                const badgeClass = {
                    success: 'success',
                    error: 'danger',
                    processing: 'info',
                    pending: 'warning'
                }[status];

                const statusText = status.toUpperCase();
                
                // Format response for display
                let responseText = '';
                if (response) {
                    if (typeof response === 'object') {
                        try {
                            responseText = JSON.stringify(response, null, 2);
                        } catch(e) {
                            responseText = String(response);
                        }
                    } else {
                        responseText = String(response);
                    }
                    
                    // Truncate if too long
                    if (responseText.length > 100) {
                        responseText = responseText.substring(0, 100) + '...';
                    }
                }

                // Current time
                const now = new Date();
                const timeString = now.toLocaleTimeString();

                // Create table row
                const row = `
                    <tr class="result-row ${status}">
                        <td><strong>${number}</strong></td>
                        <td>
                            <span class="badge bg-${badgeClass} status-badge">
                                ${statusText}
                            </span>
                        </td>
                        <td><small class="font-monospace">${responseText || '-'}</small></td>
                        <td><small class="text-muted">${timeString}</small></td>
                        <td>
                            ${urlUsed ? 
                                `<span class="badge url-badge">${urlUsed.split('/').pop()}</span>` : 
                                '<small class="text-muted">-</small>'
                            }
                        </td>
                    </tr>
                `;

                $('#resultsTable').prepend(row);
            }

            // Make API request with current working URL
            async function makeRequest(number) {
                if (!state.workingUrl) {
                    // If no working URL found from test, use the selected one
                    const apiPath = $('#apiUrl').val();
                    state.workingUrl = `http://beta.frodlybd.com${apiPath}`;
                }
                
                const url = `${state.workingUrl}?number=${encodeURIComponent(number)}`;
                
                try {
                    const response = await $.ajax({
                        url: url,
                        method: 'GET',
                        dataType: 'json',
                        timeout: 15000,
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    return {
                        success: true,
                        data: response,
                        url: url
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: error.statusText || 'Request failed',
                        status: error.status,
                        url: url
                    };
                }
            }

            // Process next number
            async function processNext() {
                if (!state.isRunning || state.isPaused || state.index >= phoneNumbers.length) {
                    return;
                }

                const number = phoneNumbers[state.index];
                addResult(number, 'processing', 'Sending request...');

                const result = await makeRequest(number);
                state.processed++;

                if (result.success) {
                    addResult(number, 'success', result.data.data || result.data, result.url);
                    state.success++;
                } else {
                    addResult(number, 'error', result.error, result.url);
                    state.errors++;
                }

                state.index++;
                updateProgress();

                // Continue processing if not finished
                if (state.isRunning && !state.isPaused && state.index < phoneNumbers.length) {
                    startCountdown(10, phoneNumbers[state.index]);
                } else if (state.index >= phoneNumbers.length) {
                    completeProcessing();
                }
            }

            // Start countdown for next request
            function startCountdown(seconds, nextNumber) {
                let countdown = seconds;
                
                if (state.timer) clearInterval(state.timer);
                
                function updateCountdown() {
                    if (countdown > 0) {
                        $('#countdownInfo').html(`
                            <div class="alert alert-warning py-2 mb-0">
                                <i class="fas fa-clock"></i> 
                                Next request (${nextNumber}) in <strong>${countdown}</strong> seconds
                            </div>
                        `);
                        countdown--;
                    } else {
                        $('#countdownInfo').empty();
                        clearInterval(state.timer);
                        processNext();
                    }
                }
                
                updateCountdown();
                state.timer = setInterval(updateCountdown, 1000);
            }

            // Start processing
            function startProcessing() {
                if (state.isRunning) return;
                
                state.isRunning = true;
                state.isPaused = false;
                
                $('#startBtn').prop('disabled', true);
                $('#pauseBtn').prop('disabled', false);
                $('#stopBtn').prop('disabled', false);
                
                processNext();
            }

            // Toggle pause/resume
            function togglePause() {
                state.isPaused = !state.isPaused;
                
                if (state.isPaused) {
                    $('#pauseBtn').html('<i class="fas fa-play"></i> Resume');
                    $('#pauseBtn').removeClass('btn-warning').addClass('btn-success');
                    
                    if (state.timer) {
                        clearInterval(state.timer);
                        state.timer = null;
                    }
                    $('#countdownInfo').html('<div class="alert alert-info">PAUSED</div>');
                } else {
                    $('#pauseBtn').html('<i class="fas fa-pause"></i> Pause');
                    $('#pauseBtn').removeClass('btn-success').addClass('btn-warning');
                    
                    if (state.index < phoneNumbers.length) {
                        startCountdown(3, phoneNumbers[state.index]);
                    }
                }
            }

            // Stop processing
            function stopProcessing() {
                state.isRunning = false;
                state.isPaused = false;
                
                if (state.timer) {
                    clearInterval(state.timer);
                    state.timer = null;
                }
                
                $('#startBtn').prop('disabled', false);
                $('#pauseBtn').prop('disabled', true);
                $('#stopBtn').prop('disabled', true);
                $('#pauseBtn').html('<i class="fas fa-pause"></i> Pause');
                $('#pauseBtn').removeClass('btn-success').addClass('btn-warning');
                
                $('#countdownInfo').empty();
            }

            // Complete processing
            function completeProcessing() {
                stopProcessing();
                $('#countdownInfo').html(`
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> 
                        Processing complete! ${state.success} successful, ${state.errors} failed
                    </div>
                `);
            }

            // Reset everything
            function resetProcessing() {
                stopProcessing();
                
                state.index = 0;
                state.processed = 0;
                state.success = 0;
                state.errors = 0;
                state.workingUrl = null;
                
                $('#resultsTable').html(`
                    <tr id="noResults">
                        <td colspan="5" class="text-center text-muted py-4">
                            No results yet. Click "Test API Call" or "Start Processing"
                        </td>
                    </tr>
                `);
                
                updateProgress();
                $('#countdownInfo').empty();
            }
        });
    </script>
</body>
</html>